## 0. 들어가기 전에

MySQL 서버에서 디스크에 저장된 데이터 파일의 크기는 일반적으로 쿼리의 처리 성능과도 직결되지만 **백업 및 복구 시간과도 밀접하게 연결**된다.

디스크의 데이터 파일이 크면 클수록 쿼리를 처리하기 위해서 더 많은 데이터 페이지를 InnoDB 버퍼 풀로 읽어야 할 수도 있고, 새로운 페이지가 버퍼 풀로 적재되기 때문에 그만큼 더티 페이지가 더 자주 디스크로 기록돼야 한다. 물론 그만큼의 저장 공간이 필요하기 때문에 비용 문제도 있을 수 있다. 많은 DBMS가 이런 문제점을 해결하기 위해 데이터 압축 기능을 제공한다.

MySQL 서버에서 사용 가능한 압축 방식은 크게 테이블 압축과 페이지 압축 두 가지 종류가 있다.

---

## 1. 페이지 압축

“Transparent Page Compression” 이라고도 불리는데, MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장되고, 반대로 MySQL 서버가 디스크에서 데이터 페이지를 읽어올 때 압축이 해제되기 때문이다.

페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에만 지원되는 **펀치 홀**이라는 기능을 제공한다.

(데이터 페이지를 압축한 결과가 용량이 얼마나 될지 예측이 불가능한데 적어도 하나의 테이블은 동일한 크기의 페이지(블록)로 통일돼야 한다는 것 ← 내가 이해한 것 : 펀치홀은 일정한 공간을 채우는 빈 공간…? 제로산소처럼?)

실제 페이지 압축은 많이 사용되지 않는다.

**[사용하는 법]**

```jsx
// 테이블 생성
mysql> CREATE TABLE t1 (cl INT) COMPRESSION="zlib";

// 테이블 변경
mysql > ALTER TABLE t1 COMPRESSION="zlib";
mysql > OPTIMIZE TABLE t1;
```

---

## 2. 테이블 압축

디스크의 데이터 파일 크기를 줄일 수 있기 때문에 일반적으로 활용도가 높음.

**[테이블 압축 단점]**

-   버퍼 풀 공간 활용률 낮음
-   쿼리 처리 성능 낮음
-   빈번한 데이터 변경 시 압축률 떨어짐

**[처리 과정]**

압축 테이블 생성 → KEY_BLOCK_SIZE 결정 → 압축된 페이지의 버퍼 풀 적재 및 사용 → 테이블 압축 관련 설정

### **2-1. 압축 테이블 생성**

전제조건 : 압축을 사용하려는 테이블에 별도의 테이블 스페이스를 사용

가장 중요한 것 : 원본 데이터 페이지의 압축 결과가 목표 크기보다 작거나 같을 때까지 반복해서 페이지를 스플릿하는 것.

\*\* 그래서 목표 크기가 잘못 설정되면 MySQL 서버의 처리 성능이 급격히 떨어짐

### 2-2. KEY_BLOCK_SIZE 결정

테이블 압축을 적용하기 전, 먼저 KEY_BLOCK_SIZE를 4KB 또는 8KB로 테이블을 생성해서 샘플 데이터를 저장해보고 적절한지 판단하는 것이 좋다. 일반적으로 압축 실패율은 3~5% 미만으로 유지할 수 있게 KEY_BLOCK_SIZE를 선택하는 것이 좋다.

-   압출 실패율이 높다고 해서 압축을 사용하지 말아야 한다는 것을 의미하지 않는다.
-   테이블 압축은 zlib를 이용해 압축을 실행하는데, 예상외로 압축 알고리즘은 많은 CPU 자원을 소모한다.

### 2-3. 압축된 페이지의 버퍼 풀 적재 및 사용

InnoDB 스토리지 엔진은 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면 압축된 상태와 압축이 해제된 상태 2개 버전을 관리한다.

### 2-4. 테이블 압축 관련 설정

-   `innodb_cmp_per_index_enable` : 테이블 압축이 사용된 테이블의 모든 인덱스별로 압축 성공 및 압축 실행 횟수를 수집하도록 설정
-   `innodb_compression_level` : 압축률 설정. 값이 작을수록 압축 속도는 빠라지지만 저장 공간은 커짐
-   `innodb_compression_failure_threshold_pct`, `innodb_compression_pad_pct_max`
-   `innodb_log_compressed_pages` : 압축된 페이지를 리두 로그에 기록하는 것. 기본값이 ON
