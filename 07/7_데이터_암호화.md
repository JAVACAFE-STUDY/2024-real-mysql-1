# 7장 데이터 암호화
- 데이터 파일, 언두로그, 리두 로그, 복제를 위한 로그 등도 모두 전부 암호화를 지원함. 
- DB 에서는 테이블 단위로 암호화를 적용함.
- 응용 프로그램 암호화는 주로 중요 정보를 가진 컬럼 단위로 암호화를 수행함

## 1. MySQL 서버 데이터 암호화
- 데이터를 메모리에서 읽을 때만 암복호화를 실행한다 = TDE 방식 
  - TDE는 디스크저장 단계에서만 암호화 된다는 의미로 사용됨 
- 그 이외에는 신경쓰지 않아도 됨.

1. 2단계 키 관리 
   - 테이블 스페이스 키는 외부에 절대 노출 되지 않음 (디스크에 저장)
   - 마스터 키는 노출되므로 주기적으로 바꿔줘야함.
   - 마스터 키가 변경되면 암호화 데이터도 변경되는데 테이블 스페이스 키와 원본 데이터는 변경되지 않음. 
   - 테이블 스페이스 키 변경시 모든 데이터를 다시 복호화했다가 암호화 해야해서 성능에 무리가 많이 감
2. 암호화 성능
   - 디스크로부터 읽은 데이터를 복호화해 InnoDB 버퍼 풀에 적재 됨 
   - 적재 이후부터는 암호화 되지 않은 데이터와 동일한 성능을 보임
   - 디스크에서 새롭게 읽어와야할 페이지가 많을수록 복호화 지연으로 성능 하락함
   - 암호화와 압축이 동시에 진행되면 압축 먼저 한 후에 암호화를 적용한다.
     - 암호화 데이터 용량을 최소화 하기 위함
   - 암호화를 하면 읽기 성능 3~5배, 쓰기 성능 5~6배 느려짐
3. 암호화와 복제
   - 복제된 데이터를 복호화하려면 복제된 서버에도 마스터 키가 있어야함
   - 레플리카 서버의 마스터 키와 테이블스페이스 키가 다르므로 암호화된 데이터는 완전히 달라짐

## 2. keyring_file 플러그인 설치 
- MySQL 암호화 기능은 플러그인 방식으로 제공된다
  - 해당 플러그인은 마스터 키를 생성하고 관리하는 부분까지만 담당한다.
- 마스터키는 평문으로 디스크에 저장된다. 마스터 키가 외부에 노출된다면 데이터 암호화는 무용지물이 된다. 

## 3. 테이블 암호화
### 테이블 생성
- 테이블 생성시 마지막에 ENCRYPTION='Y' 옵션을 추가로 넣으면 된다.
- 암호화 기본 설정하려면 시스템 변수 default_table_encryption 을 on 으로 설정하면 된다. 

### 응용 프로그램 암호화와 비교
- 응용 프로그램에서 미리 암호화해서 넣는 방법
- 인덱스 기능을 100프로 활용하기 힘들다.

### 테이블 스페이스로 이동
- 데이터를 테이블 스페이스 단위로 옮길 때 암호화가 적용된 경우 신경써야 하는 부분
- FLUSH 파일의 데이터 파일과 마스터 키가 저장된 *.cfp 파일을 함께 복사해야 한다. 

### 언두 로그 및 리두 로그 암호화
- 디스크에서 읽을 때 복호화가 이루어졌으므로 평문으로 저장된다.
- innodb_redo_log_encrypt, innodb_undo_log_encrypt 시스템 변수를 on 으로 설정하면 리두 로그도 암호화 된다.
- 암호화전 데이터는 암호화되기 전 상태로 남아있기때문에 주의해야 한다. 

## 5. 바이너리 로그 암호화
- 바이너리 로그는 한번 저장되면 오랫동안 저장되므로 암호화가 더 중요하다
