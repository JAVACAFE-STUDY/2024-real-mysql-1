## MySQL 엔진 아키텍처

MySQL은 MySQL 엔진과 스토리지 엔진으로 구분할 수 있다

- MySQL
  - 클라이언트로부터 접속 및 쿼리 요청을 처리하는 커넥션 핸들러
  - SQL 파서 및 전처리기
  - 쿼리의 최적화된 실행을 위한 옵티마이저
- 스토리지 엔진
  - 실제 데이터의 저장, 읽기
- 핸들러 API
  - MySQL 엔진 쿼리 실행기에서 데이터를 쓰거나 읽을 때, 각 스토리지 엔진에 쓰기 또는 읽기를 요청하는데, 이러한 요청을 핸들러 요청이라고 한다

MySQL에서 MySQL 엔진은 하나지만, 스토리지 엔진은 여러 개를 동시에 사용할 수 있다. 테이블이 사용할 스토리지 엔진을 지정하면, 해당 테이블은 모든 읽기, 변경 작업이 정의된 스토리지 엔진으로 처리된다

## MySQL 스레딩 구조

MySQL은 프로세스 기반이 아닌, 스레드 기반으로 동작하고, 크게 포그라운드, 백그라운드 스레드로 구분할 수 있다

## InnoDB 스토리지 아키텍처

MySQL의 스토리지 엔진 중 가장 많이 사용되는 InnoDB 스토리지 엔진은 거의 유일하게 레코드 기반의 잠금을 제공하며, 그 때문에 높은 동시성 처리가 가능하며 성능이 뛰어나다.

InnoDB 엔진의 구성 요소는 다음과 같다.

- 메모리 영역
  - 어댑티브 해시 인덱스
  - 언두 페이지
  - 데이터 페이지 버퍼
  - 로그 버퍼
  - 체인지 버퍼

## 프라이머리 키에 의한 클러스터링

InnoDB의 모든 테이블은 기본적으로 프라이머리 키를 기준으로 클러스터링되어 저장된다.
즉, 프라이머리 키 값의 순서대로 디스크에 저장된다는 뜻이며, 모든 세컨더리 인덱스는 레코드의 주소 대신 프라이머리 키의 값을 논리적인 주소로 사용한다.

MyISAM 스토리지 엔진에서는 클러스터링 키를 지원하지 않으므로, MyISAM 테이블에서는 프라이머리 키와 세컨더리 인덱스는 구조적으로 차이가 없다.

## 외래 키 지원

외래 키 지원은 InnoDB 스토리지 엔진 레벨에서 지원하는 기능이다. 외래 키를 사용하면 정합성을 유지할 수 있다는 장점이 있지만, 제약으로 인해 단점이 발생하기도 한다.

> 실무에서 외래키 제약 조건을 사용하는지?

## MVCC

일반적으로 레코드 레벨의 트랜잭션을 지원하는 DBMS가 제공하는 기능이며, MVCC의 가장 큰 목적은 잠금을 사용하지 않는 일관된 읽기를 제공하는데 있다.
InnoDB는 언두 로그를 이용해 이 기능을 구현한다.

## 잠금 없는 일관된 읽기

InnoDB 스토리지 엔진은 MVCC를 이용해 잠금을 사용하지 않고, 읽기 작업을 수행한다.

## 자동 데드락 감지

InnoDB 스토리지 엔진은 내부적으로 잠금이 교착 상태에 빠지지 않았는지 체크하기 위해 잠금 대기 목록을 그래프 형태로 관리한다.
이는 InnoDB 스토리지 엔진의 데드락 감지 스레드를 통해 그래프를 주기적으로 검사해 교착 상태에 빠진 트랜잭션을 강제 종료한다.

## 자동화된 장애 복구

InnoDB 스토리지 엔진은 매우 견고해서 데이터 파일이 손상되거나 MySQL이 실행되지 못하는 경우는 거의 발생하지 않는다.
하지만 디스크나 하드웨어 이슈로 InnoDB 스토리지 엔진이 복구를 하지 못하는 경우가 발생할 수 있다.
InnoDB 데이터 파일은 기본적으로 서버가 시작될 때 항상 자동 복구를 수행하는데, 이 단계에서 파일에 손상이 있다면 복구를 멈추고 MySQL은 종료된다.

## InnoDB 버퍼풀

InnoDB 스토리지의 가장 핵심적인 부분으로, 디스크의 데이터 파일이나 인덱스 정보를 메모리에 캐시해두는 공간이다.
쓰기 작업을 지연시켜 일괄 작업으로 처리할 수 있게 해주는 버퍼 역할도 한다.

### 언두 로그

InnoDB 스토리지 엔진은 트랜잭션과 격리 수준을 보장하기위해 DML로 변경되기 이전 버전의 데이터를 별도로 백업한다. 이렇게 백업된 데이터를 언두 로그라고 한다. 언두 로그는 다음과 같이 사용된다. 

- 트랜잭션 보장
- 격리 수준 보장

### 체인지 버퍼

RDBMS에서 레코드가 INSERT 되거나 UPDATE 될 때는 데이터 파일을 변경하는 작업뿐 아니라 해당 테이블에 포함된 인덱스를 업데이트 하는 작업도 필요하다. 이때 사용하는 임시 메모리 공간을 체인지 버퍼라고 한다.

### 리두 로그

리두 로그는 ACID 에서 D와 연관이 깊다. 리두 로그는 문제점으로 인해 MySQL이 비정상적으로 종료됐을 때 데이터 파일에 기록되지 못한 데이터를 잃지 않게 해주는 안전장치이다. MySQL을 포함한 대부분의 데이터베이스는 데이터 변경 내용을 로그로 먼저 기록한다. 따라서 데이터베이스는 쓰기 비용이 낮은 자료구조를 가진 리두 로그를 가지고 있으며, 비정상적인 종료가 발생하면 리두 로그의 내용을 이용해 서버가 종료되기 이전으로 복구한다.

## 어뎁티브 해시 인덱스 

사용자가 수동으로 생성하는 인덱스가 아닌, InnoDB 스토리지 엔진에서 사용자가 자주 요청하는 데이터에 의해 자동으로 생성하는 인덱스다.

## MyISAM 스토리지 엔진 아키텍처

InnoDB 핵심이 버퍼 풀이라면, MyISAM은 키 캐시가 그 역할을 한다.

## 키 캐시

키 캐시는 인덱스를 대상으로 동작하며,인ㄷ덱스의디스크쓰기 작업에 대해서만 부분적으로 버퍼 역할을 한다.

## 슬로우 쿼리 로그 

MySQL 쿼리 튜닝은 서비스에 적용하기 전에 전체적으로 튜닝하는 경우와 서비스 운영중에 전체적인 성능 점검을 위한튜닝으로 나눌 수 있다.
