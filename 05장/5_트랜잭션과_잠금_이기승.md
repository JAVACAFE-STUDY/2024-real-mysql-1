# 트랜잭션과 잠금

## 트랜잭션

- MySQL에서의 트랜잭션
    - 트랜잭션은 하나의 논리적인 작업셋 자체가 100% 적용하거나 적용되지 않아야 함을 보장해주는 것.
    - MyISAM 스토리지 엔진은 트랜잭션을 지원하지 않음.
    - InnoDB 스토리지 엔진은 트랜잭션을 지원함.
- 주의 사항
    - 프로그램 코드가 데이터베이스 커넥션을 가지는 범위와
    - 트랜잭션이 활성화돼 있는 프로그램의 범위를 최소화하는 것이 좋음.

## MySQL 엔진의 잠금

- 글로벌 락
    - `FLSUH TABLES WITH READ LOCK` 명령으로 획득가능
    - MySQL에서 제공하는 잠금 중 가장 범위가 크다.
    - SELECT를 제외한 대부분의 DDL, DML 문장을 실행하면 글로벌 락이 해제될 때까지 대기한다.
- 테이블 락
    - `LOCK TABLES table_name [ READ | WRITE ]` 명령으로 획득가능
    - `UNLOCK TABLES` 명령으로 해제한다.
    - 테이블 락은 테이블 단위로 잠금을 걸 수 있다.
    - InnoDB 스토리지 엔진에서는 테이블 락을 사용하지 않는 것이 좋다.
        - InnoDB 테이블에서는 대부분의 DML 쿼리에서는 무시되고 스키마를 변경하는 DDL 경우에만 영향을 미친다.
- 네임드 락
    - `GET_LOCK()` 함수로 획득가능
    - `RELEASE_LOCK()` 함수로 해제한다.
    - 네임드 락은 MySQL 서버 전체에서 사용할 수 있는 잠금이다.
        - 많은 레코드에 대해서 복잡한 요건으로 레코드를 변경하는 트랜잭션에 유용하게 사용할 수 있다.
    - 모든 네임드 락을 해제하는 방법
        - `RELEASE_ALL_LOCKS()` 명령으로 해제한다.
- 메타데이터 락
    - MySQL 서버의 메타데이터에 대한 잠금은 MySQL 서버의 내부적인 작업을 위해 사용된다.
        - 테이블 생성, 변경, 삭제, 인덱스 생성, 변경, 삭제 등의 작업을 수행할 때 사용된다.
        - 테이블 락과 네임드 락은 사용자가 직접 획득하고 해제할 수 있지만, 메타데이터 락은 MySQL 서버가 내부적으로 사용한다.

## InnoDB 스토리지 엔진 잠금

- InnoDB 스토리지 엔진은 트랜잭션을 지원하고, 트랜잭션을 위한 잠금을 제공한다.
- 레코드 락
    - InnoDB 스토리지 엔진은 레코드 단위로 잠금을 걸 수 있다.
    - InnoDB는 레코드 잔체가 아니라 인덱스의 레코드를 잠그는 것이다.
    -
- 갭 락
    - 레코드와 바로 인접한 레코드 사이의 간격만을 잠그는 것
    - 레코드와 레코드 사이의 간격에 새로운 레코드가 생성되는 것을 제어한다
    - 넥스트 키 락의 일부로 자주 사용
- 넥스트 키 락
    - 레코드 락과 갭 락을 합쳐 놓은 형태의 잠금
    - 바이너리 로그에 기록되는 쿼리가 레플리카 서버에서 실행될 때,
    - 소스 서버에서 만들어낸 결과가 동일한 결과를 만들어내도록 보장하는 것이 주목적이다.
- 자동 증가 락
    - `AUTO_INCREMENT`락은 `INSERT`나 `REPLACE` 문장을 실행할 때 사용된다.
    - `AUTO_INCREMENT`락을 명시적으로 획득하고 해제하는 방법은 없다.

## MySQL의 격리 수준
|                  | DIRTY READ | NON-REPEATABLE READ | PHANTOM READ    |
|------------------|------------|---------------------|-----------------|
| READ UNCOMMITTED | 발생         | 발생                  | 발생              |
| READ COMMITTED   | 없음         | 발생                  | 발생              |
| REPEATABLE READ  | 없음         | 없음                  | 발생 (InnoDB는 없음) |
| SERIALIZABLE     | 없음         | 없음                  | 없음              |

- READ UNCOMMITTED
  - 다른 트랜잭션이 커밋하지 않은 데이터를 읽을 수 있다. (Dirty Read)
  - RDBMS 표준에서는 트랜잭션 격리 수준으로 인정하지 않을 정도로 문제가 많은 격리 수준이다.
- READ COMMITTED
  - 다른 트랜잭션이 커밋한 데이터만 읽을 수 있다.
  - Dirty Read가 발생하지 않는다.
  - 하지만 Non-Repeatable Read나 Phantom Read가 발생할 수 있다.
- REPEATABLE READ
  - 같은 트랜잭션 내에서는 같은 쿼리를 실행해도 항상 같은 결과를 보장한다.
  - InnoDB 스토리지 엔진에서는 REPEATABLE READ 격리 수준을 사용할 때 Phantom Read가 발생하지 않는다.
  - REPEATABLE READ 격리 수준은 InnoDB 스토리지 엔진에서 기본으로 사용되는 격리 수준이다.
- SERIALIZABLE
  - 가장 엄격한 격리 수준이다.
  - 다른 트랜잭션이 데이터를 변경하거나 삽입할 수 없다.
  - 다른 트랜잭션이 삽입한 데이터를 읽을 수 없다.
