# 트랜잭션과 잠금

### 트랜잭션

작업의 완전성 보장
논리적인 작업 셋 모두 완벽하게 처리하거나, 모두 처리하지 않는 것을 보장

- 잠금: 동시성 제어, 여러 커넥션 동시 요청할 때 하나의 커넥션만 변경할 수 있도록 제어
- 트랜잭션: 데이터 정합성 보장
- 격리 수준: 트랜잭션 내 또는 간의 작업을 어떻게 공유하고 차단할지 결정하는 레벨

쿼리 개수 상관없이 논리적으로 100% 적용(커밋) 또는 100% 취소(롤백)되어야 함

#### 주의사항

- 트랜잭션은 데이터베이스 연산의 최소 단위로 적용

### MySQL 엔진의 잠금

#### 글로벌 락

데이터베이스 서버 전체에 걸리는 락
MySQL 서버 백업락: 정상적으로 복재는 되나 백업 실패를 막기위해 DDL 명령 실행되면 복제 일시 중지

#### 테이블 락

개별 테이블 단위로의 잠금 (테이블 동기화)

#### 네임드 락

임의의 문자열에 대한 잠금
동일한 데이터 변경 및 참조 시 네임드락으로 해결 가능

#### 메타데이터 락

테이블 구조 (데이터베이스 객체; 테이블, 뷰 등)의 이름 등을 잠금

### InnoDB 스토리지 엔진 잠금

#### 레코드 락

인덱스 레코드에 대한 잠금
인덱스 없어도 내부적으로 생성된 클러스터 인덱스를 사용

#### 갭 락

레코드와 레코드 사이의 간격 잠금

#### 넥스트 키 락

레코드 락과 갭 락을 합쳐 놓은 형태의 잠금

#### 자동 증가 락

AUTO_INCREMENT 컬럼에 대한 잠금

### 인덱스와 잠금

변경할 레코드를 찾기 위해 인덱스를 사용하면 모든 인덱스 레코드에 잠금을 걸어야 함

### MySQL의 격리 수준

#### READ UNCOMMITTED

어떤 트랜잭션에서 변경한 데이터를 다른 트랜잭션에서 읽을 수 있음
DIRTY READ(다른 트랜잭션에서 변경한 데이터를 읽을 수 있음) 발생
데이터 정합성 문제 많음

#### READ COMMITTED

어떤 트랜잭션에서 변경한 데이터를 다른 트랜잭션에서 읽을 수 없음

REPEATABLE READ(항상 같은 결과를 가져와야 함)의 정합성에 문제 발생

#### REPEATABLE READ

InnoDB 스토리지 엔진은 변경 전 레코드를 언두 공간에 백업하고 실제 레코드 변경 ; MVCC
동일한 트랜잭션 내에서 동일한 결과를 보여줌

PHANTOM READ(다른 트랜잭션에서 수행한 작업에 의해 레코드가 보였다 안 보였다 함) 발생

#### SERIALIZABLE

한 트랜잭션의 레코드를 다른 트랮잭션에서 변경할 수 없음

PHANTOM READ(다른 트랜잭션에서 수행한 작업에 의해 레코드가 보였다 안 보였다 함) 없음
