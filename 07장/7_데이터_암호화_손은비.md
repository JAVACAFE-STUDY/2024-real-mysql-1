## 0. 들어가기 전에

-   MySQL 8.0 이전에는 데이터 파일(테이블 스페이스)에 대해서만 암호화 기능이 제공되었지만, MySQL 8.0 업그레이드 후 리드 로그, 언두 로그, 복제를 위한 바이너리 로그 등도 모두 암호화 기능을 지원
-   데이터 암호화 여부는 보안 감사에서 필수적
-   핀테크에서는 응용 프로그램에서 암호화한 데이터를 데이터베이스 서버에서 다시 암호화하는 이중 암호화 방법 선택하기도 함

## 1. MySQL 서버의 데이터 암호화

-   MySQL 서버(InnoDB 스토리지 엔진) I/O 레이어에서만 데이터의 암호화 및 복호화 과정이 실행
-   MySQL 서버에서 사용자의 쿼리를 처리하는 과정에서 테이블의 데이터가 암호화돼 있는지 여부를 식별할 필요가 없으며, 암호화 테이블도 그렇지 않은 테이블과 동일한 처리 과정을 거친다. → `TDE(Transparent Data Encryption)`

**[2단계 키 관리]**

![스크린샷 2024-10-24 오후 7.56.23.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/9f0c08f1-728e-42d2-bbf3-345b741ebfc9/17759112-72ca-425a-8fc4-65d4c50a8fbc/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2024-10-24_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_7.56.23.png)

다양한 플러그인이 제공되지만 마스터 키를 관리하는 방법만 다를 뿐 서버 내부적으로 작동하는 방식은 모두 동일하다. 데이터 암호화는 마스터 키와 테이블스페이스 키라는 두 종류의 키를 가지고 있는데, 테이블스페이스 키는 프라이빗 키라고도 한다.

테이블스페이스 키는 절대 서버 외부로 노출되지 않지만 마스터 키는 외부의 파일을 이용하기 때문에 노출될 가능성이 있다. 그래서 마스터 키는 주기적으로 변경해야 한다.

## 2. keyring_file 플러그인 설치

-   MySQL 서버의 데이터 암호화 기능인 TDE와 암호화 키 관리는 플러그인 방식으로 제공된다.
-   MySQL 서버의 다른 플러그인과는 달리, TDE 플러그인의 경우 MySQL 서버가 시작되는 단계에서도 가장 빨리 초기화돼야 한다.

## 3. 테이블 암호화

키링 플러그인은 마스터 키를 생성하고 관리하는 부분까지만 담당하기 때문에 어떤 키링 플러그인을 사용하든 관계없이 암호화된 테이블을 생성하고 활용하는 방법은 모두 동일하다.

테이블을 다른 서버로 복사해야 하는 경우 또는 특정 테이블의 데이터 파일만 백업했다가 복구하는 경우라면 테이블스페이스 이동 기능이 레코드를 덤프했다가 복구하는 방식보다 훨씬 효율적이고 빠르다.

## 4. 언두 로그 및 리두 로그 암호화

테이블의 암호화를 적용하더라도 디스크로 저장되는 데이터만 암호화되고 MySQL 서버의 메모리에 존재하는 데이터는 복호화된 평문으로 관리되며, 이 평문 데이터가 테이블의 데이터 파일 이외의 디스크 파일로 기록되는 경우에는 여전히 평문으로 저장된다.

그래서 **테이블 암호화를 적용해도 리두 로그나 언두 로그, 그리고 복제를 위한 바이너리 로그에는 평문으로 저장되는 것**이다.

**[InnoDB 리두 로그가 암호화되었는지 확인하는 법]**

`mysql> SHOW GLOBAL VARIABLES LIKE ‘innodb_redo_log_encrypt’;`

## 5. 바이너리 로그 암호화

테이블암호화가 적용되도 바이너리 로그와 릴레이 로그 또한 평문을 저장한다.

일반적으로 언두 로그와 리두 로그는 크게 보안에 민감하지 않을 수 있지만 바이너리 로그는 의도적으로 상당히 긴 시간 동안 보관하는 서비스도 있고 때로는 증분 백업을 위해 바이너리 로그를 보관하기도 한다. 이런 이유로 바이너리 로그 암호화는 상황에 따라 중요도가 높아진다.
