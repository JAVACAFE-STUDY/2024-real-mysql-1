# 9. 옵티마이저와 힌트

- 옵티마이저는 데이터 분포도를 바탕으로한 통계 데이터까지 고려해 실행 계획을 수립함

## 1. 개요

### 쿼리 실행 절차

1. SQL 구문 해석
2. 어떤 인덱스 읽을지 선택 -> 실행 계획 수립
3. 데이터 가져옴

### 옵티마이저의 종류

1. 비용 기반 최적화: CBO
    - 테이블 통계 정보를 사용함.
    - 대부분의 DBMS가 사용함
2. 규칙 기반 최적화: RBO
    - 통계 데이터를 고려하지 않음
    - 거의 항상 같은 실행계획을 사용함
    - 예전에 사용하던 방식

## 2. 기본 데이터 처리
### 풀 테이블 스캔
- 인덱스를 사용하지 않고 테이블의 데이터를 풀로 읽음.
- 사용 경우
  1. 데이터가 너무 없는 경우 
  2. 인덱스를 이용할 조건 절이 없는 경우
  3. 인덱스 레인지 스캔을 사용할 수 있지만 조건 일치 레코드 건수가 너무 많은 경우
- 풀스캔 시에는 페이지를 한개씩 읽는게 아니고 병렬로 여러 페이지를 읽음
### 풀 인덱스 스캔
- 인덱스만 읽어서 스캔함
- 전체 데이터를 읽을 필요가 없으므로 풀 테이블 스캔보다 성능이 좋음 

### 병렬 처리
- 쿼리 병렬 처리 할 수 있음

### Order By 처리(Using filesort)
1. 소트 버퍼
    - 정렬을 수행하기 위한 메모리 공간
    - 정렬이 필요할 때만 할당됨
    - 정렬할 레코드 수가 소트 버퍼보다 크면 임시 디스크를 사용함
    - 소트 버퍼는 크다고 좋은게 아니고 56KB ~ 1MB 미만으로 사용하는걸 권장함.
    - 소트 버퍼는 세션 메모리 영역에서 동작하며 전역으로 사용되지 않음.
      - 커넥션이 많을 수록 소트 버퍼 영역도 늘어남
2. 정렬 알고리즘
   1. 싱글 패스 정렬 방식
      - select 대상이 되는 컬럼을 모두 담아서 정렬을 수행함. 
      - 필요 없는 컬럼도 넣어서 정렬 수행
   2. 투 패스 정렬 방식
      - 대상 컬럼과 pk키만 넣어서 정렬을 수행함
      - 투패스 방식은 두번 읽어야되기 때문에 싱글 패스 방식을 더 많이 사용함
      - 레코드 크기가 max_langth_for_sort_data 보다 크면 투패스 방식을 사용함
      - BLOB 이나 TEXT 가 select 대상에 포함될때도 투패스 방식을 이용함 
   
3. 정렬 처리 방법
   1. 인덱스 사용
      - 인덱스를 사용할 수 있는 경우
      - 조인의 경우 첫번째 오는 테이블의 order by 순서대로 인덱스가 있어야함
      - 인덱스를 통해 정렬이 되는 경우 order by 가 없어도 정렬되어서 나오지만 자체 최적화를 하기때문에 명시해주는 게 좋음
   2. 조인에서 드라이빙 테이블만 정렬
      - 조인을 실행하기 전에 드라이빙 테이블의 레코드를 먼저 정렬한 후 조인함
      - order by 컬럼이랑 where절에 있는 인덱스를 보고 어떤 테이블을 드라이빙 테이블로 삼을지 결정함 
   3. 조인에서 조인 결과를 임시 테이블로 저장 후 정렬
      - 위 방법 다 안되면 쓰는 마지막 방법
      - 실행계획에 Using temporary, Using filesort 라고 나옴
      - 드라이빙 테이블 레코드 개수만큼 조인이 일어나서 성능 안좋음
      - limit를 써도 성능 좋아지기가 힘듦
   4. 성능 비교
   - order by 절이있으면 limit 이 있어도 성능 향상 효과를 누리기 어려움
      1. 스트리밍 방식
         - 실행하는 즉시 가져옴 -> 자바의 스트림과 비슷한 듯
         - order by 와 group by 는 스트림 처리가 불가능함.
      2. 버퍼링 방식
         - 스트리밍방식과 반대
         - 결과를 모아서 일괄 가공하는 방식

### Group By 처리
- 스트리밍 처리가 불가능함. 
- having 절로 튜닝해봤자 소용없으므로 노력하지 않아도 됨
1. 인덱스 스캔을 이용한는 group by
    - order by 절과 동일함
2. 루스 인덱스 스캔을 이용하는 group by
   - 루스 인덱스 스캔: 인덱스의 레코드를 건너 뛰면서 필요한 부분만 읽어서 가져오는 걸 의미함
   - 실행 계획에 Using index for group-by 라고 나옴
   - join 시에는 사용 불가능
   - 다중 컬럼 인덱스 일 때 사용 가능 (p.307)
